name: CI

on:
  push:
    branches: [ main, test ]
  pull_request:
    branches: [ main, test ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - path: web-scraper
            target: app
          - path: web-scraper
            target: worker
          - path: web-scraper
            target: beat
          - path: llm
            target: worker
          - path: differ_module/postgres_api
          - path: gui

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          set -e

          if [ -n "${{ matrix.target }}" ]; then
            IMAGE=test-${{ matrix.path }}-${{ matrix.target }}
          else
            IMAGE=test-${{ matrix.path }}
          fi

          echo "Running container from image: $IMAGE"

          case "${{ matrix.path }}" in
            web-scraper)
              docker run -d --name webscraper-${{ matrix.target }} $IMAGE
              ;;
            llm)
              docker run -d --name llm-${{ matrix.target }} $IMAGE
              ;;
            differ_module/postgres_api)
              docker run -d --name postgres-api -p 5011:5011 $IMAGE
              ;;
            gui)
              docker run -d --name gui -p 3000:3000 $IMAGE
              ;;
            *)
              echo "No run configuration for path=${{ matrix.path }}"
              ;;
          esac

      - name: Run and Log Container
        run: |
          set -e

          if [ "${{ matrix.path }}" == "web-scraper" ]; then
            docker run -d --name webscraper-${{ matrix.target }} test-${{ matrix.path }}-${{ matrix.target }}
            sleep 5
            docker logs webscraper-${{ matrix.target }}

          elif [ "${{ matrix.path }}" == "llm" ]; then
            docker run -d --name llm-${{ matrix.target }} test-${{ matrix.path }}-${{ matrix.target }}
            sleep 5
            docker logs llm-${{ matrix.target }}

          elif [ "${{ matrix.path }}" == "differ_module/postgres_api" ]; then
            docker run -d --name postgres_api_container -p 5011:5011 test-${{ matrix.path }}
            sleep 5
            docker logs postgres_api_container

          elif [ "${{ matrix.path }}" == "gui" ]; then
            docker run -d --name gui-container -p 3000:3000 test-${{ matrix.path }}
            sleep 5
            docker logs gui-container
          fi
          
      - name: Check GUI Endpoint
        if: matrix.path == 'gui'
        run: |
          sleep 5
          curl -f http://localhost:3000 || (echo "GUI did not respond" && exit 1)

      - name: Cleanup
        if: always()
        run: |
          docker ps -a -q | xargs -r docker stop
          docker ps -a -q | xargs -r docker rm
